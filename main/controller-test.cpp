#include <iostream>
#include "Cia402device.h"
#include "CiA301CommPort.h"
#include "SocketCanPort.h"

#include "fcontrol.h"

using namespace std;


int main()
{

    double dts=0.01;

    TimeSignal irdelta(valarray<double> {1, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
                ,dts);
    //fractional integrator FIR s^0.857
    TimeSignal ir1(valarray<double> {0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958}
                ,dts);
    FSystemBlock c1(ir1);

    SystemBlock motor(vector<double>{1, 1},
                      vector<double>{-1, 1},
                      0.5
                      );//simple integrator

    double out;
    double target=100;
    double error=0;

    for(double i=0;i<0.01/dts;i+=dts)
    {


        //control diagram
        error = target - motor.GetState();
        0.05*error  >  motor;

        //c1.OutputUpdate(1);


        cout << i << ", " << motor.GetState() << endl;
        sleep(dts);

    }


    return 0;
}
